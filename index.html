<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <link rel="icon" href="data:,"> 
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- New Chat Button -->
            <div class="sidebar-header">
                <button id="newChatBtn" class="new-chat-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>ÏÉà Ï±ÑÌåÖ</span>
                </button>
            </div>

            <!-- Conversations List -->
            <div id="conversationsList" class="conversations-list">
                <!-- ÎåÄÌôî Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>

            <!-- Bottom Menu -->
            <div class="sidebar-footer">
                <!-- Î°úÍ∑∏Ïù∏ ÏïàÎê® ÏÉÅÌÉú -->
                <div id="authButtons" class="auth-buttons">
                    <a href="login.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        <span>Î°úÍ∑∏Ïù∏</span>
                    </a>
                    <a href="signup.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span>ÌöåÏõêÍ∞ÄÏûÖ</span>
                    </a>
                </div>

                <!-- Î°úÍ∑∏Ïù∏Îê® ÏÉÅÌÉú -->
                <div id="userMenu" class="user-menu hidden">
                    <button id="accountBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="userName">ÎÇ¥ Í≥ÑÏ†ï</span>
                    </button>
                    <button id="settingsBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.196-13.804l-4.243 4.243m0 6.364l4.243 4.243M23 12h-6m-6 0H1m18.804-5.196l-4.243 4.243m0 6.364l4.243 4.243"></path>
                        </svg>
                        <span>ÏÑ§Ï†ï</span>
                    </button>
                    <button id="logoutBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>Î°úÍ∑∏ÏïÑÏõÉ</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <button id="toggleSidebarBtn" class="menu-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                
                <div class="model-selector">
                    <button id="modelBtn" class="model-btn">
                        <span id="currentModelText">GPT-4</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="modelMenu" class="model-menu hidden" style="max-height: 400px; overflow-y: auto;">
    
                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ÏµúÏã† (Next Gen)</div>
                        <div class="model-option" data-value="gpt-5.1">
                            <div class="model-name">GPT-5.1</div>
                            <div class="model-desc">2025 ÏµúÏã† Î™®Îç∏ (ÏµúÍ≥† ÏÑ±Îä•)</div>
                        </div>
                        <div class="model-option" data-value="gpt-5">
                            <div class="model-name">GPT-5</div>
                            <div class="model-desc">Í∞ïÎ†•Ìïú ÏÑ±Îä• Î∞è Ï∂îÎ°† Îä•Î†•</div>
                        </div>
                        <div class="model-option" data-value="gpt-5-mini">
                            <div class="model-name">GPT-5 Mini</div>
                            <div class="model-desc">GPT-5Ïùò Í≤ΩÎüâÌôî Î≤ÑÏ†Ñ</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">Ïò¥Îãà (Omni)</div>
                        <div class="model-option" data-value="gpt-4o">
                            <div class="model-name">GPT-4o</div>
                            <div class="model-desc">Í∞ÄÏû• ÎòëÎòëÌïòÍ≥† Îπ†Î¶Ñ (Ï∂îÏ≤ú)</div>
                        </div>
                        <div class="model-option" data-value="gpt-4o-mini">
                            <div class="model-name">GPT-4o Mini</div>
                            <div class="model-desc">ÏÜçÎèÑ Îπ†Î•¥Í≥† Îß§Ïö∞ Ï†ÄÎ†¥Ìï®</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">Ï∂îÎ°† (Reasoning)</div>
                        <div class="model-option" data-value="o1">
                            <div class="model-name">OpenAI o1</div>
                            <div class="model-desc">Î≥µÏû°Ìïú ÏàòÌïô/ÏΩîÎî©/Í≥ºÌïô Ìï¥Í≤∞</div>
                        </div>
                        <div class="model-option" data-value="o1-mini">
                            <div class="model-name">OpenAI o1-mini</div>
                            <div class="model-desc">Îπ†Î•∏ Ï∂îÎ°† Î™®Îç∏</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">Í∏∞Ï°¥ Î™®Îç∏ (Legacy)</div>
                        <div class="model-option" data-value="gpt-4-turbo">
                            <div class="model-name">GPT-4 Turbo</div>
                            <div class="model-desc">GPT-4 ÏôÑÏÑ±Ìòï</div>
                        </div>
                        <div class="model-option" data-value="gpt-4">
                            <div class="model-name">GPT-4</div>
                            <div class="model-desc">Ïò§Î¶¨ÏßÄÎÑê GPT-4</div>
                        </div>
                        <div class="model-option" data-value="gpt-3.5-turbo">
                            <div class="model-name">GPT-3.5 Turbo</div>
                            <div class="model-desc">Îπ†Î•¥Í≥† Í∞ÄÎ≤ºÏö¥ Íµ¨Î≤ÑÏ†Ñ</div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Messages Area -->
            <div id="messagesContainer" class="messages-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-content">
                        <div class="empty-icon">üí¨</div>
                        <h2 class="empty-title">Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?</h2>
                    </div>
                </div>
                <div id="messagesList" class="messages-list">
                    <!-- Î©îÏãúÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <p class="input-disclaimer">
                    ChatGPTÎäî Ïã§ÏàòÎ•º Ìï† Ïàò ÏûàÏäµÎãàÎã§. Ï§ëÏöîÌïú Ï†ïÎ≥¥Îäî ÌôïÏù∏ÌïòÏÑ∏Ïöî.
                </p>
            </div>
        </main>
    </div>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const userStr = localStorage.getItem('user');
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userNameSpan = document.getElementById('userName');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesList = document.getElementById('messagesList');
    const conversationsList = document.getElementById('conversationsList'); // ÏÇ¨Ïù¥ÎìúÎ∞î Î™©Î°ù
    const emptyState = document.getElementById('emptyState');

    let currentUser = null;
    let currentConversationId = null; // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî ÎåÄÌôîÎ∞© ID

    const toggleBtn = document.getElementById('toggleSidebarBtn'); // ÏôºÏ™Ω ÏÉÅÎã® ÏïÑÏù¥ÏΩò Î≤ÑÌäº
    const sidebar = document.getElementById('sidebar');            // ÏÇ¨Ïù¥ÎìúÎ∞î ÏöîÏÜå

    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed'); // ÌÅ¥ÎûòÏä§Î•º Ï§¨Îã§ Î∫èÏóàÎã§ Ìï®
        });
    }

    // 0.5 Î™®Îç∏ ÏÑ†ÌÉù Í∏∞Îä•
    const modelBtn = document.getElementById('modelBtn');
    const modelMenu = document.getElementById('modelMenu');
    const currentModelText = document.getElementById('currentModelText');
    let currentModel = 'gpt-4'; // Í∏∞Î≥∏Í∞í

    // Î©îÎâ¥ Ïó¥Í∏∞/Îã´Í∏∞
    modelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        modelMenu.classList.toggle('hidden');
    });

    // Î™®Îç∏ ÏÑ†ÌÉùÌïòÍ∏∞
    document.querySelectorAll('.model-option').forEach(option => {
        option.addEventListener('click', () => {
            currentModel = option.dataset.value; // ÏÑ†ÌÉùÌïú Î™®Îç∏ Í∞í Ï†ÄÏû•
            
            // Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω (ÏÑ§Î™Ö ÎπºÍ≥† Ïù¥Î¶ÑÎßå)
            currentModelText.textContent = option.querySelector('.model-name').textContent;
            
            modelMenu.classList.add('hidden'); // Î©îÎâ¥ Îã´Í∏∞
        });
    });

    // ÌôîÎ©¥ ÏïÑÎ¨¥Îç∞ÎÇò ÌÅ¥Î¶≠ÌïòÎ©¥ Î©îÎâ¥ Îã´Í∏∞
    document.addEventListener('click', () => {
        if (!modelMenu.classList.contains('hidden')) {
            modelMenu.classList.add('hidden');
        }
    });

    // 1. Ï¥àÍ∏∞Ìôî Î∞è Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Ï≤¥ÌÅ¨
    if (userStr) {
        currentUser = JSON.parse(userStr);
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        userNameSpan.textContent = currentUser.name;
        messageInput.disabled = false;
        
        // Î°úÍ∑∏Ïù∏ÌñàÏúºÎ©¥ ÎåÄÌôî Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        loadConversations();
    } else {
        messageInput.disabled = true;
        messageInput.placeholder = "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.";
    }

    // 2. Î°úÍ∑∏ÏïÑÏõÉ
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            localStorage.removeItem('user');
            window.location.reload();
        }
    });

    // 3. ÏÉà Ï±ÑÌåÖ Î≤ÑÌäº
    document.getElementById('newChatBtn').addEventListener('click', () => {
        currentConversationId = null;
        messagesList.innerHTML = ''; // ÌôîÎ©¥ ÎπÑÏö∞Í∏∞
        emptyState.classList.remove('hidden');
        loadConversations(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® (ÏÑ†ÌÉù Ìö®Í≥º Ï†úÍ±∞Ïö©)
    });

    // 4. ÎåÄÌôî Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ìï®Ïàò
    // 4. ÎåÄÌôî Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ìï®Ïàò (ÏàòÏ†ïÎê®: ÏÇ≠Ï†ú Î≤ÑÌäº Ï∂îÍ∞Ä)
    async function loadConversations() {
        if (!currentUser) return;
        const res = await fetch(`/api/conversations/${currentUser.id}`);
        const conversations = await res.json();
        
        conversationsList.innerHTML = ''; // Í∏∞Ï°¥ Î™©Î°ù Ï¥àÍ∏∞Ìôî
        
        conversations.forEach(conv => {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            
            // HTML Íµ¨ÏÑ±: Ï†úÎ™© + ÏÇ≠Ï†ú Î≤ÑÌäº(Ìú¥ÏßÄÌÜµ)
            div.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-actions">
                    <button class="conversation-action-btn delete-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `;

            // 1. Î™©Î°ù ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ ÎåÄÌôî Î∂àÎü¨Ïò§Í∏∞
            div.addEventListener('click', () => loadMessages(conv.id));

            // 2. ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            const deleteBtn = div.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // Î∂ÄÎ™® ÏöîÏÜå(Î™©Î°ù) ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ (Ï§ëÏöî!)
                
                if (confirm('Ï†ïÎßê Ïù¥ ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    try {
                        const res = await fetch(`/api/conversations/${conv.id}`, { method: 'DELETE' });
                        if (res.ok) {
                            // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî Î∞©ÏùÑ ÏÇ≠Ï†úÌñàÎã§Î©¥ ÌôîÎ©¥ ÎπÑÏö∞Í∏∞
                            if (currentConversationId === conv.id) {
                                document.getElementById('newChatBtn').click();
                            }
                            loadConversations(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        } else {
                            alert('ÏÇ≠Ï†ú Ïã§Ìå®');
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }
            });

            conversationsList.appendChild(div);
        });
    }

    // 5. ÌäπÏ†ï ÎåÄÌôî ÎÇ¥Ïö© Î∂àÎü¨Ïò§Í∏∞ Ìï®Ïàò
    async function loadMessages(conversationId) {
        currentConversationId = conversationId;
        emptyState.classList.add('hidden');
        messagesList.innerHTML = ''; // ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî

        const res = await fetch(`/api/conversations/${conversationId}/messages`);
        const messages = await res.json();

        messages.forEach(msg => appendMessage(msg.role, msg.content));
        
        // ÏÇ¨Ïù¥ÎìúÎ∞î ÏÑ†ÌÉù Ìö®Í≥º (Í∞ÑÎã®Ìûà)
        loadConversations().then(() => {
            // Ïó¨Í∏∞Ïóê ÏÑ†ÌÉùÎêú Ìï≠Î™© ÌïòÏù¥ÎùºÏù¥Ìä∏ Î°úÏßÅ Ï∂îÍ∞Ä Í∞ÄÎä•
        });
    }

    // 6. Î©îÏãúÏßÄ Ï†ÑÏÜ°
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    messageInput.addEventListener('input', () => sendBtn.disabled = messageInput.value.trim() === '');
    messageInput.addEventListener('input', function() {
        // 1. Ï†ÑÏÜ° Î≤ÑÌäº ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
        sendBtn.disabled = this.value.trim() === '';
        
        // 2. ÎÜíÏù¥ Ï°∞Ï†à Î°úÏßÅ
        this.style.height = 'auto'; // ÎÜíÏù¥ Ï¥àÍ∏∞Ìôî
        this.style.height = (this.scrollHeight) + 'px'; // ÎÇ¥Ïö©ÎßåÌÅº ÎäòÎ¶¨Í∏∞
        
        // 200px ÎÑòÏúºÎ©¥ Ïä§ÌÅ¨Î°§ ÏÉùÍ∏∞Í≤å
        if (this.scrollHeight > 200) {
            this.style.overflowY = "scroll";
        } else {
            this.style.overflowY = "hidden";
        }
    });
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentUser) return;

        messageInput.value = '';
        messageInput.style.height = 'auto'; // <--- Ïù¥ Ï§ÑÏù¥ Ï§ëÏöîÌï©ÎãàÎã§! (Ï†ÑÏÜ° ÌõÑ Ï§ÑÏñ¥Îì§Í∏∞)
        sendBtn.disabled = true;
        emptyState.classList.add('hidden');
        appendMessage('user', text);

        try {
            const loadingId = appendMessage('assistant', '...'); // Î°úÎî© ÌëúÏãú
            
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    message: text,
                    conversationId: currentConversationId, // ÌòÑÏû¨ Î∞© ID (ÏóÜÏúºÎ©¥ null)
                    model: currentModel
                })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove(); // Î°úÎî© ÏÇ≠Ï†ú

            if (res.ok) {
                appendMessage('assistant', data.reply);
                
                // Ï≤òÏùå ÎåÄÌôî ÏãúÏûëÌñàÎã§Î©¥(Î∞©Ïù¥ ÏÉàÎ°ú ÏÉùÍ≤ºÎã§Î©¥) Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                if (!currentConversationId) {
                    currentConversationId = data.conversationId;
                    loadConversations();
                }
            } else {
                appendMessage('assistant', 'Error: ' + data.error);
            }
        } catch (e) {
            console.error(e);
        }
    }

    // ÌôîÎ©¥Ïóê Î©îÏãúÏßÄ Í∑∏Î¶¨Í∏∞ Ìó¨Ìçº Ìï®Ïàò
    // ÌôîÎ©¥Ïóê Î©îÏãúÏßÄ Í∑∏Î¶¨Í∏∞ Ìó¨Ìçº Ìï®Ïàò (ÏàòÏ†ïÎê®: ID Ï§ëÎ≥µ Î∞©ÏßÄ)
    function appendMessage(role, text) {
        // [ÏàòÏ†ï] Date.now() Îí§Ïóê ÎûúÎç§ Ïà´ÏûêÎ•º Î∂ôÏó¨ÏÑú Ï†àÎåÄ Ïïà Í≤πÏπòÍ≤å Ìï®
        const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const isUser = role === 'user';
        const html = `
            <div class="message" id="${msgId}">
                <div class="message-avatar ${role}">
                    ${isUser ? `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    ` : `
                    <div class="logo-icon" style="font-size: 16px;">üí¨</div>
                    `}
                </div>
                <div class="message-content">
                    <div class="message-role">${isUser ? 'ÎÇò' : 'ChatGPT'}</div>
                    <div class="message-text">${text}</div>
                </div>
            </div>
        `;
        messagesList.insertAdjacentHTML('beforeend', html);
        messagesList.scrollTop = messagesList.scrollHeight;
        return msgId;
    }
});
</script>
</html>